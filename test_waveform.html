<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>波形测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/wavesurfer.js@7.8.2/dist/wavesurfer.js"></script>
    <script src="https://unpkg.com/howler@2.2.4/dist/howler.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">波形可视化测试</h1>
        
        <!-- WaveSurfer 测试 -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">WaveSurfer.js 测试</h2>
            <div id="waveform1" class="w-full h-16 bg-gray-100 rounded mb-4"></div>
            <button id="testWaveSurfer" class="bg-blue-500 text-white px-4 py-2 rounded">测试 WaveSurfer</button>
            <div id="wavesurferStatus" class="mt-2 text-sm"></div>
        </div>

        <!-- Howler 测试 -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">Howler.js + Canvas 测试</h2>
            <div class="w-full h-16 bg-gray-100 rounded mb-4 relative">
                <canvas id="howlerCanvas" class="w-full h-full"></canvas>
                <div id="howlerProgress" class="absolute top-0 left-0 h-full bg-blue-500 opacity-30" style="width: 0%;"></div>
            </div>
            <button id="testHowler" class="bg-green-500 text-white px-4 py-2 rounded">测试 Howler + Canvas</button>
            <div id="howlerStatus" class="mt-2 text-sm"></div>
        </div>

        <!-- 原生 Audio + Canvas 测试 -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-lg font-semibold mb-4">原生 Audio + Canvas 测试</h2>
            <div class="w-full h-16 bg-gray-100 rounded mb-4 relative">
                <canvas id="nativeCanvas" class="w-full h-full"></canvas>
                <div id="nativeProgress" class="absolute top-0 left-0 h-full bg-purple-500 opacity-30" style="width: 0%;"></div>
            </div>
            <audio id="nativeAudio" controls class="w-full mb-4"></audio>
            <button id="testNative" class="bg-purple-500 text-white px-4 py-2 rounded">测试原生 Audio + Canvas</button>
            <div id="nativeStatus" class="mt-2 text-sm"></div>
        </div>

        <!-- 测试音频文件 -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">生成测试音频</h2>
            <button id="generateTestAudio" class="bg-orange-500 text-white px-4 py-2 rounded">生成测试音频</button>
            <div id="testAudioStatus" class="mt-2 text-sm"></div>
        </div>
    </div>

    <script>
        let testAudioUrl = null;
        let wavesurfer = null;
        let howlerSound = null;
        let nativeAudio = null;
        let animationId = null;

        // 生成测试音频（正弦波）
        function generateTestAudio() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = audioContext.sampleRate;
            const duration = 3; // 3秒
            const length = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);

            // 生成正弦波
            for (let i = 0; i < length; i++) {
                data[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 0.3; // 440Hz 正弦波
            }

            // 转换为 WAV blob
            const wavBlob = audioBufferToWav(buffer);
            testAudioUrl = URL.createObjectURL(wavBlob);
            
            document.getElementById('testAudioStatus').textContent = '测试音频已生成';
            document.getElementById('testAudioStatus').className = 'mt-2 text-sm text-green-600';
        }

        // AudioBuffer 转 WAV
        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const arrayBuffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(arrayBuffer);

            // WAV 头部
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, buffer.sampleRate, true);
            view.setUint32(28, buffer.sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);

            const data = buffer.getChannelData(0);
            let offset = 44;
            for (let i = 0; i < length; i++) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }

            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        // 测试 WaveSurfer
        function testWaveSurfer() {
            if (!testAudioUrl) {
                document.getElementById('wavesurferStatus').textContent = '请先生成测试音频';
                document.getElementById('wavesurferStatus').className = 'mt-2 text-sm text-red-600';
                return;
            }

            try {
                if (wavesurfer) {
                    wavesurfer.destroy();
                }

                wavesurfer = WaveSurfer.create({
                    container: '#waveform1',
                    waveColor: '#94a3b8',
                    progressColor: '#3b82f6',
                    height: 64,
                    normalize: true,
                    interact: true,
                    fillParent: true
                });

                wavesurfer.on('ready', () => {
                    document.getElementById('wavesurferStatus').textContent = 'WaveSurfer 加载成功，点击播放';
                    document.getElementById('wavesurferStatus').className = 'mt-2 text-sm text-green-600';
                });

                wavesurfer.on('error', (e) => {
                    document.getElementById('wavesurferStatus').textContent = 'WaveSurfer 错误: ' + e;
                    document.getElementById('wavesurferStatus').className = 'mt-2 text-sm text-red-600';
                });

                wavesurfer.load(testAudioUrl);

                // 点击播放
                document.getElementById('waveform1').addEventListener('click', () => {
                    wavesurfer.playPause();
                });

            } catch (error) {
                document.getElementById('wavesurferStatus').textContent = 'WaveSurfer 初始化失败: ' + error.message;
                document.getElementById('wavesurferStatus').className = 'mt-2 text-sm text-red-600';
            }
        }

        // 测试 Howler + Canvas
        function testHowler() {
            if (!testAudioUrl) {
                document.getElementById('howlerStatus').textContent = '请先生成测试音频';
                document.getElementById('howlerStatus').className = 'mt-2 text-sm text-red-600';
                return;
            }

            try {
                if (howlerSound) {
                    howlerSound.unload();
                }

                // 设置 Canvas
                const canvas = document.getElementById('howlerCanvas');
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;

                // 绘制波形
                function drawWaveform() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#94a3b8';
                    
                    const barCount = Math.floor(canvas.width / 3);
                    for (let i = 0; i < barCount; i++) {
                        const height = Math.random() * canvas.height * 0.8;
                        const x = i * 3;
                        const y = (canvas.height - height) / 2;
                        ctx.fillRect(x, y, 2, height);
                    }
                }

                drawWaveform();

                howlerSound = new Howl({
                    src: [testAudioUrl],
                    onload: () => {
                        document.getElementById('howlerStatus').textContent = 'Howler 加载成功，点击播放';
                        document.getElementById('howlerStatus').className = 'mt-2 text-sm text-green-600';
                    },
                    onplay: () => {
                        updateProgress();
                    },
                    onerror: (id, error) => {
                        document.getElementById('howlerStatus').textContent = 'Howler 错误: ' + error;
                        document.getElementById('howlerStatus').className = 'mt-2 text-sm text-red-600';
                    }
                });

                function updateProgress() {
                    if (howlerSound && howlerSound.playing()) {
                        const progress = (howlerSound.seek() / howlerSound.duration()) * 100;
                        document.getElementById('howlerProgress').style.width = progress + '%';
                        requestAnimationFrame(updateProgress);
                    }
                }

                // 点击播放
                canvas.addEventListener('click', () => {
                    if (howlerSound.playing()) {
                        howlerSound.pause();
                    } else {
                        howlerSound.play();
                    }
                });

            } catch (error) {
                document.getElementById('howlerStatus').textContent = 'Howler 初始化失败: ' + error.message;
                document.getElementById('howlerStatus').className = 'mt-2 text-sm text-red-600';
            }
        }

        // 测试原生 Audio + Canvas
        function testNative() {
            if (!testAudioUrl) {
                document.getElementById('nativeStatus').textContent = '请先生成测试音频';
                document.getElementById('nativeStatus').className = 'mt-2 text-sm text-red-600';
                return;
            }

            try {
                nativeAudio = document.getElementById('nativeAudio');
                nativeAudio.src = testAudioUrl;

                // 设置 Canvas
                const canvas = document.getElementById('nativeCanvas');
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;

                // 绘制动态波形
                function drawAnimatedWaveform() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#94a3b8';
                    
                    const barCount = Math.floor(canvas.width / 3);
                    for (let i = 0; i < barCount; i++) {
                        const height = Math.random() * canvas.height * 0.8;
                        const x = i * 3;
                        const y = (canvas.height - height) / 2;
                        ctx.fillRect(x, y, 2, height);
                    }
                    
                    if (!nativeAudio.paused) {
                        animationId = requestAnimationFrame(drawAnimatedWaveform);
                    }
                }

                nativeAudio.addEventListener('play', () => {
                    drawAnimatedWaveform();
                    updateNativeProgress();
                });

                nativeAudio.addEventListener('pause', () => {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                });

                function updateNativeProgress() {
                    if (!nativeAudio.paused && nativeAudio.duration) {
                        const progress = (nativeAudio.currentTime / nativeAudio.duration) * 100;
                        document.getElementById('nativeProgress').style.width = progress + '%';
                        requestAnimationFrame(updateNativeProgress);
                    }
                }

                drawAnimatedWaveform();
                document.getElementById('nativeStatus').textContent = '原生 Audio 设置成功';
                document.getElementById('nativeStatus').className = 'mt-2 text-sm text-green-600';

            } catch (error) {
                document.getElementById('nativeStatus').textContent = '原生 Audio 初始化失败: ' + error.message;
                document.getElementById('nativeStatus').className = 'mt-2 text-sm text-red-600';
            }
        }

        // 事件监听器
        document.getElementById('generateTestAudio').addEventListener('click', generateTestAudio);
        document.getElementById('testWaveSurfer').addEventListener('click', testWaveSurfer);
        document.getElementById('testHowler').addEventListener('click', testHowler);
        document.getElementById('testNative').addEventListener('click', testNative);

        // 页面加载时检查库是否可用
        window.addEventListener('load', () => {
            console.log('WaveSurfer available:', typeof WaveSurfer !== 'undefined');
            console.log('Howler available:', typeof Howl !== 'undefined');
        });
    </script>
</body>
</html>
